<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Socket.io</title>
    </head>
 
    <body>
        <h1>Communication avec socket.io !</h1>

        <script src="/socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src='https://cdn.rawgit.com/admsev/jquery-play-sound/master/jquery.playSound.js'></script>

		<form action="/" method="post" id="formulaire_chat">
            <input type="text" name="message" id="message" placeholder="Votre message..." size="50" autofocus />
            <input type="submit" id="envoi_message" value="Envoyer" />
        </form>

        <script>
		
			var sounds = ["http://noproblo.dayjo.org/ZeldaSounds/OOT/OOT_Navi_Hello1.wav","http://noproblo.dayjo.org/ZeldaSounds/OOT/OOT_Navi_Hey1.wav","http://noproblo.dayjo.org/ZeldaSounds/OOT/OOT_Navi_Listen1.wav","http://noproblo.dayjo.org/ZeldaSounds/OOT/OOT_Navi_WatchOut1.wav"];
            var socket = io.connect('http://localhost:8080');
			
			var pseudo = prompt('Quel est votre pseudo ?');
			var port = 0;
			
			function addMessageLocal(message){
				$('#myTable > tbody:last-child').prepend('<tr><td style="color:blue">'+pseudo+': </td><td>'+message+'</td></tr>');
			}
			function addMessage(message){
				$('#myTable > tbody:last-child').prepend('<tr><td>'+message.pseudo+': </td><td>'+message.message+'</td></tr>');
				var position = Math.floor((Math.random() * sounds.length));;

				$.playSound(sounds[position]);
			}
			function addPseudo(pseudo){
				$('#myTable > tbody:last-child').prepend('<tr><td style="color:green"> New client: </td><td>'+pseudo+'</td></tr>');
			}
			function delPseudo(pseudo){
				$('#myTable > tbody:last-child').prepend('<tr><td style="color:red"> Client quit: </td><td>'+pseudo+'</td></tr>');
			}
			
			socket.emit('login', pseudo);
			socket.on('message', function(message) {
				console.log('message',message);
				//alert('Le serveur a un message pour vous : ' + message);
			})
			socket.on('portFast', function(message) {
				port = message;
				console.log('portFast'+message);
			})
			socket.on('message', function(message) {				
				addMessage(message);
				console.log('receving message'+message);
			})
			socket.on('clientConnect', function(message) {
				console.log('clientConnect'+message);
				addPseudo(message);
			})			
			socket.on('clientDisconnect', function(message) {
				console.log('clientConnect'+message);
				delPseudo(message);
			})

			socket.on('connectTo', function(message) {
				console.log('connectTo'+message);
				addPseudo(message);
				$('#myTable > tbody:last-child').prepend('<tr><td>'+message +' connected !</td></tr>');
			})
			
			$('#formulaire_chat').submit(function () {
                var message = $('#message').val();
                socket.emit('message', message); // Transmet le message aux autres
				addMessageLocal(message);

                $('#message').val('').focus(); // Vide la zone de Chat et remet le focus dessus
                return false; // Permet de bloquer l'envoi "classique" du formulaire
            });

        </script>
		<h2>Messages </h2>
		<table id="myTable">
		  <tbody>
		  </tbody>
		</table>
    </body>
</html>